image: docker:24.0.5

services:
  - docker:24.0.5-dind

  # Secret Detection
  SECRET_DETECTION_ENABLED: 'true'

stages:
  - test
  - secret-detection
  - build-image
  - publish-chart

# Secret Detection Job
include:
  - template: Security/Secret-Detection.gitlab-ci.yml

# Job to build and push multi-arch Docker image (Linux amd64 & arm64)
build-multiarch-image:
  stage: build-image
  before_script:
    - echo "Logging into GitLab Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
    # Install QEMU emulators for multi-arch build
    - docker run --privileged --rm tonistiigi/binfmt --install all
    # Create a new builder instance
    - docker buildx create --name mybuilder --driver docker-container --bootstrap
    - docker buildx use mybuilder
  script:
    - |
      echo "Building and pushing image to GitLab Registry..."
      # Uses CI_REGISTRY_IMAGE which maps to registry.example.com/group/project
      docker buildx build --platform linux/amd64,linux/arm64 \
        --tag "$CI_REGISTRY_IMAGE:latest" \
        --tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" \
        --push .
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Job to package and publish Helm chart as OCI artifact
publish-helm-chart:
  stage: publish-chart
  image: alpine/helm:3.12.3
  before_script:
    - echo "Logging into GitLab Registry (Helm)..."
    - echo "$CI_REGISTRY_PASSWORD" | helm registry login "$CI_REGISTRY" --username "$CI_REGISTRY_USER" --password-stdin
  script:
    - echo "Packaging Helm chart..."
    - helm package charts/agile-retro
    - echo "Pushing Helm chart to OCI registry..."
    - helm push agile-retro-*.tgz oci://$CI_REGISTRY_IMAGE/charts
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
