image: docker:24.0.5

services:
  - docker:24.0.5-dind

variables:
  DOCKER_REGISTRY: $CI_REGISTRY
  DOCKER_USER: $CI_REGISTRY_USER
  DOCKER_PASSWORD: $CI_REGISTRY_PASSWORD
  IMAGE_NAME: $CI_PROJECT_PATH
  SECRET_DETECTION_ENABLED: 'true'

stages:
  - test
  - secret-detection
  - build-image
  - publish-chart

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

build-multiarch-image:
  stage: build-image
  before_script:
    - echo "Logging into registry..."
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - docker run --privileged --rm tonistiigi/binfmt --install all
    - docker buildx create --name mybuilder --driver docker-container --bootstrap
    - docker buildx use mybuilder
  script:
    - |
      echo "Building and pushing image for linux/amd64 and linux/arm64..."
      docker buildx build --platform linux/amd64,linux/arm64 \
        --tag "$DOCKER_REGISTRY/$IMAGE_NAME:latest" \
        --tag "$DOCKER_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" \
        --cache-from type=registry,ref=$DOCKER_REGISTRY/$IMAGE_NAME:buildcache \
        --cache-to type=registry,ref=$DOCKER_REGISTRY/$IMAGE_NAME:buildcache,mode=max \
        --push .
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

publish-helm-chart:
  stage: publish-chart
  image: alpine/helm:3.12.3
  before_script:
    - echo "Logging into Helm registry..."
    - echo "$DOCKER_PASSWORD" | helm registry login "$DOCKER_REGISTRY" --username "$DOCKER_USER" --password-stdin
  script:
    - echo "Packaging Helm chart..."
    - helm package charts/agile-retro
    - echo "Pushing Helm chart to OCI registry..."
    - helm push agile-retro-*.tgz oci://$DOCKER_REGISTRY/$IMAGE_NAME/charts
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
